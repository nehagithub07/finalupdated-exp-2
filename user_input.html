<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Input</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
  <div class="w-full max-w-xl bg-white rounded-2xl border border-slate-200 shadow p-6">
    <h1 class="text-2xl font-bold text-slate-900">User Input Form</h1>
    <p class="text-slate-600 mt-1">Fill details to enable the experiment + progress report.</p>

    <form id="userForm" class="mt-6 space-y-4">
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">Name</label>
        <input id="name" type="text" required
          class="w-full rounded-xl border border-slate-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">Email</label>
        <input id="email" type="email" required
          class="w-full rounded-xl border border-slate-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
       
      </div>

      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-1">Designation</label>
        <select id="designation" required
          class="w-full rounded-xl border border-slate-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <option value="">Select…</option>
          <option>Student</option>
          <option>Faculty</option>
          <option>Researcher</option>
          <option>Other</option>
        </select>
      </div>

      <div class="flex gap-2 justify-end pt-2">
        <button id="cancelBtn" type="button"
          class="px-4 py-2 rounded-xl border border-slate-300 font-semibold text-slate-700 hover:bg-slate-100">
          Cancel
        </button>
        <button type="submit"
          class="px-4 py-2 rounded-xl bg-slate-900 text-white font-semibold hover:bg-black">
          Save & Continue
        </button>
      </div>
    </form>

    <p id="errorBox" class="hidden mt-4 text-sm font-semibold text-red-600"></p>
  </div>

  <script src="./progress_tracker.js"></script>
  <script>
    // ✅ Edit your allowed domains here:
    const ALLOWED_DOMAINS = [
      "university.edu",
      "iitr.ac.in",
      "gmail.com"
      // add more like: "spu.edu"
    ];

    function getReturnUrl() {
      const u = new URL(window.location.href);
      return u.searchParams.get("return") || "aim.html";
    }

    function showError(msg) {
      const el = document.getElementById("errorBox");
      el.textContent = msg;
      el.classList.remove("hidden");
    }

    function clearError() {
      document.getElementById("errorBox").classList.add("hidden");
      document.getElementById("errorBox").textContent = "";
    }

    function isAllowedEmail(email) {
      const e = String(email || "").trim().toLowerCase();
      const at = e.lastIndexOf("@");
      if (at <= 0) return false;
      const domain = e.slice(at + 1);
      return ALLOWED_DOMAINS.some(d => domain === d || domain.endsWith("." + d));
    }

    document.getElementById("cancelBtn").addEventListener("click", () => {
      const returnUrl = getReturnUrl();
      // if opened inside modal iframe, inform parent
      try { window.parent.postMessage({ type: "vlab:user_input_cancel" }, "*"); } catch {}
      window.location.href = returnUrl;
    });

    document.getElementById("userForm").addEventListener("submit", (e) => {
      e.preventDefault();
      clearError();

      if (!window.VLProgress) {
        showError("Progress tracker missing. Check ./progress_tracker.js path.");
        return;
      }

      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const designation = document.getElementById("designation").value.trim();

      if (!name || !email || !designation) {
        showError("Please fill all fields.");
        return;
      }

      if (!isAllowedEmail(email)) {
        showError("Email domain not allowed. Use a permitted institutional email.");
        return;
      }

      VLProgress.setUser({ name, email, designation });

      const returnUrl = getReturnUrl();

      // notify parent if inside iframe modal
      try {
        window.parent.postMessage({ type: "vlab:user_input_submitted", returnUrl }, "*");
      } catch {}

      window.location.href = returnUrl;
    });
  </script>
</body>
</html>
